name: Monday Dependency Report

on:
  schedule:
    # Every Monday at 9:00 AM Eastern (14:00 UTC)
    - cron: '0 14 * * 1'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  dependency-report:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependency Dashboard
        id: dashboard
        uses: actions/github-script@v7
        with:
          script: |
            // Find the Dependency Dashboard issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: 'renovate[bot]',
              state: 'open',
              per_page: 10
            });
            
            const dashboard = issues.data.find(i => 
              i.title.includes('Dependency Dashboard')
            );
            
            if (!dashboard) {
              core.setOutput('found', 'false');
              core.setOutput('summary', 'No Dependency Dashboard found. Renovate may not be configured.');
              core.setOutput('body', '');
              return;
            }
            
            core.setOutput('found', 'true');
            core.setOutput('url', dashboard.html_url);
            core.setOutput('body', dashboard.body || '');
            
            // Parse the dashboard for pending updates
            const body = dashboard.body || '';
            
            // Count unchecked items (pending approvals)
            const pendingApprovals = (body.match(/- \[ \]/g) || []).length;
            const openPRs = (body.match(/- \[x\]/g) || []).length;

            // Check for rate-limited or errored items
            const hasErrors = body.includes('‚ö†') || body.includes('‚ùå');
            const hasRateLimited = body.toLowerCase().includes('rate-limited');
            
            // Build summary
            let summary = `üìä *Dashboard Summary*\n`;
            summary += `‚Ä¢ Awaiting Approval: *${pendingApprovals}* updates\n`;
            summary += `‚Ä¢ Open PRs: *${openPRs}* in progress`;
            
            if (hasErrors) {
              summary += `\n‚Ä¢ ‚ö†Ô∏è *Errors detected* - check dashboard`;
            }
            if (hasRateLimited) {
              summary += `\n‚Ä¢ üê¢ Some updates are rate-limited`;
            }
            
            core.setOutput('summary', summary);
            core.setOutput('pending', pendingApprovals.toString());
            core.setOutput('dashboard_url', dashboard.html_url);

      - name: AI Risk Assessment
        id: ai_analysis
        if: steps.dashboard.outputs.found == 'true' && steps.dashboard.outputs.pending != '0'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DASHBOARD_BODY: ${{ steps.dashboard.outputs.body }}
        run: |
          # Create the prompt
          PROMPT="You are a dependency update risk assessor for a Next.js/React project.

          Analyze this Renovate Dependency Dashboard and provide a brief risk assessment for each pending update (items with unchecked boxes).

          For each pending update, provide:
          - Package name and version change
          - Risk level: LOW (patch/minor, safe), MEDIUM (minor with notable changes), or HIGH (major version, breaking changes likely)
          - One-line explanation

          Keep it concise - max 3-4 lines per package. Focus only on updates awaiting approval (unchecked boxes).
          If there are more than 5 pending updates, summarize the top 5 highest-risk ones.

          Format for Slack (use *bold* for emphasis, no markdown headers).

          Dashboard content:
          $DASHBOARD_BODY"

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                "model": "claude-opus-4-5-20251101",
                "max_tokens": 1024,
                "messages": [{"role": "user", "content": $prompt}]
              }')")

          # Extract the text response
          AI_TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // "Unable to generate AI analysis."')
          
          # Handle potential errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            AI_TEXT="‚ö†Ô∏è AI analysis unavailable: $(echo "$RESPONSE" | jq -r '.error.message')"
          fi

          # Output for next step (escape for GitHub Actions)
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set AI Output Fallback
        id: ai_fallback
        if: steps.ai_analysis.outcome == 'skipped' || steps.dashboard.outputs.pending == '0'
        run: |
          echo "analysis=‚úÖ *All clear!* No pending updates require review this week." >> $GITHUB_OUTPUT

      - name: Send to Slack
        if: always()
        uses: slackapi/slack-github-action@v1.27.1
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üóìÔ∏è Monday Dependency Report",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.dashboard.outputs.summary) }}
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ steps.ai_analysis.outputs.analysis && toJSON(format('ü§ñ *AI Risk Assessment*\n\n{0}', steps.ai_analysis.outputs.analysis)) || toJSON(steps.ai_fallback.outputs.analysis) }}
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üëâ <${{ steps.dashboard.outputs.dashboard_url }}|Open Dashboard> to review"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Repo: ${{ github.repository }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
